# 実装計画

## 1. 型定義の拡張とユーティリティ層の構築

### 1.1 (P) Floor型にfloorTypeフィールドを追加
- [x] Floor型に`floorType: 'above-ground' | 'basement'`フィールドを追加する
- [x] オプショナルフィールドとして定義し、デフォルト値'above-ground'を設定する
- [x] 型定義ファイルを更新し、TypeScriptコンパイルエラーがないことを確認する
- _Requirements: 3.3, 5.1, 5.2, 5.3_

### 1.2 (P) 階生成ユーティリティ関数を実装
- [x] 地上階数と地階数から階配列を生成する純粋関数を作成する
- [x] 地上階は"1階", "2階", ...の形式で命名し、floorTypeを'above-ground'に設定する
- [x] 地階は"地下1階", "地下2階", ...の形式で命名し、floorTypeを'basement'に設定する
- [x] 各階に一意のUUID（generateUUID使用）を割り当てる
- [x] 初期値として共用部面積を0、usagesとusageGroupsを空配列に設定する
- _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3_

### 1.3 (P) 差分検出ユーティリティ関数を実装
- [x] 現在の階配列と目標階配列を比較し、差分を検出する純粋関数を作成する
- [x] 階名とfloorTypeの組み合わせで一致判定を行う
- [x] 既存階が目標階に存在する場合、既存階のデータ（usages、共用部面積、usageGroups）を保持する
- [x] 追加が必要な階と削除が必要な階のIDを特定する
- [x] マージ後の階配列と削除対象階IDを返却する
- _Requirements: 2.5, 2.6, 2.7, 4.1, 4.2, 4.3_

### 1.4 (P) カスケード削除ユーティリティ関数を実装
- [x] 階削除時のグループ共用部の整合性を維持する純粋関数を作成する
- [x] 削除階に所属するグループ共用部を削除する
- [x] 削除階の用途IDを収集し、他階のグループ共用部から該当用途IDを除外する
- [x] 除外後の用途数が2未満になったグループ共用部を削除する（二次削除）
- [x] 整合性維持後の階配列を返却する
- _Requirements: 4.4, 4.5, 4.6_

### 1.5 (P) ユーティリティ関数の単体テストを作成
- [x] 階生成関数のテスト: 地上階・地階の正しい生成、階名の形式、floorTypeの設定を検証する
- [x] 差分検出関数のテスト: 既存データ保持、追加/削除対象の特定、エッジケースを検証する
- [x] カスケード削除関数のテスト: グループ共用部削除、用途ID除外、二次削除を検証する
- [x] エッジケースのテスト: 全階削除、循環参照、用途ID重複などを網羅する
- _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

## 2. バリデーションサービスの拡張

### 2.1 (P) 整数バリデーション機能を追加
- [x] ValidationServiceに`validateInteger`メソッドを追加する
- [x] 0以上の整数のみを許可し、負の数・小数・非数値を拒否する
- [x] 最大値制限（1000階）を実装する
- [x] エラーメッセージに具体的な制限値と修正方法を含める
- _Requirements: 1.3, 1.4, 1.5, 8.1, 8.5_

### 2.2 (P) 整数バリデーションの単体テストを作成
- [x] 正の整数・0が成功することを検証する
- [x] 負の数・小数・最大値超過が失敗することを検証する
- [x] エラーメッセージの内容を検証する
- _Requirements: 1.3, 1.4, 1.5, 8.1_

## 3. 階数入力UIコンポーネントの実装

### 3.1 FloorCountInputコンポーネントを作成
- [x] 地上階数と地階数の数値入力フィールドを持つコンポーネントを作成する
- [x] ローカルステートで入力値とバリデーションエラーを管理する
- [x] 入力時にvalidateIntegerを呼び出し、リアルタイムバリデーションを実行する
- [x] バリデーションエラーをフィールド下に表示する
- [x] onChange経由で親コンポーネントに階数変更を通知する
- _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

### 3.2 FloorCountInputにアクセシビリティ機能を実装
- [x] 各入力フィールドにlabel要素を関連付ける
- [x] type="number"属性を設定し、0以上の整数のみを受け付ける
- [x] バリデーションエラーをaria-live="polite"領域で通知する
- [x] aria-label属性を設定し、スクリーンリーダー対応を実装する
- [x] キーボード操作で全機能が利用可能であることを確保する
- _Requirements: 1.6, 9.1, 9.2, 9.3, 9.4, 9.5_

### 3.3 (P) FloorCountInputコンポーネントの単体テストを作成
- [x] 地上階数・地階数の入力値が正しくステートに反映されることを検証する
- [x] 無効な値入力時にバリデーションエラーが表示されることを検証する
- [x] ARIA属性が正しく設定されていることを検証する
- [x] キーボード操作で全機能が利用可能であることを検証する
- _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 9.1, 9.2, 9.3, 9.4, 9.5_

## 4. 階管理アクションの拡張

### 4.1 AppStateContextにSET_FLOOR_COUNTSアクションを追加
- [x] AppActionユニオン型に`SET_FLOOR_COUNTS`アクション型を追加する
- [x] ペイロードとして`floors: Floor[]`と`deletedFloorIds: string[]`を含める
- [x] Reducer内にSET_FLOOR_COUNTSケースを実装し、階配列を更新する
- [x] 型安全性を確保し、TypeScriptコンパイルエラーがないことを確認する
- _Requirements: 2.5, 2.6, 2.7, 6.1, 6.2_

### 4.2 useFloorActionsにsetFloorCounts関数を実装
- [x] 地上階数と地階数を受け取るsetFloorCounts関数を作成する
- [x] 最低1階制約をバリデーションする（地上階数 + 地階数 >= 1）
- [x] 階生成ユーティリティで目標階配列を生成する
- [x] 差分検出ユーティリティで現在階と目標階を比較する
- [x] 階削除時のデータ損失を検出し、確認ダイアログを表示する（window.confirm使用）
- [x] 確認ダイアログでキャンセルが選択された場合、処理を中止する
- [x] OKが選択された場合、カスケード削除ユーティリティを実行する
- [x] SET_FLOOR_COUNTSアクションをディスパッチし、状態を更新する
- _Requirements: 2.5, 2.6, 2.7, 6.1, 6.2, 8.2, 8.3, 8.4_

### 4.3 (P) setFloorCounts関数の単体テストを作成
- [x] 階数増加時に不足階のみが追加されることを検証する
- [x] 階数減少時に余剰階のみが削除されることを検証する
- [x] 既存階のデータが保持されることを検証する
- [x] 最低1階制約が維持されることを検証する
- [x] データ損失検出と確認ダイアログの動作を検証する
- _Requirements: 2.5, 2.6, 2.7, 4.1, 4.2, 4.3, 6.1, 6.2, 8.2, 8.3, 8.4_

## 5. FloorManagerコンポーネントの拡張

### 5.1 FloorManagerにFloorCountInputを組み込み
- [x] FloorManagerにFloorCountInputコンポーネントを配置する
- [x] 既存の階データから地上階数と地階数を逆算する関数（deriveFloorCounts）を実装する
- [x] FloorCountInputのonChangeでsetFloorCountsを呼び出す
- [x] 「階を追加」ボタンと各階の「削除」ボタンを削除する
- [x] 既存の階名編集機能、共用部面積入力機能を保持する
- _Requirements: 1.1, 1.2, 6.3, 6.4, 7.1, 7.2, 7.3, 10.1, 10.2, 10.3_

### 5.2 FloorManagerに階ソート機能を実装
- [x] 階配列を論理的順序でソートする関数（sortFloors）を実装する
- [x] 地上階を降順（上階から下階）でソートする
- [x] 地階を降順（地下1階から下層へ）でソートする
- [x] ソート後の配列は地上階 + 地階の順で結合する
- [x] 階名から階数を抽出する関数（extractFloorNumber）を実装する
- [x] 階数変更時に階リストの表示順序を自動的に更新する
- _Requirements: 5.1, 5.2, 5.3, 5.4_

### 5.3 (P) FloorManagerの統合テストを作成
- [x] 地上階数・地階数入力で階リストが更新されることを検証する
- [x] 階順序が論理的（地上階降順 → 地階降順）に表示されることを検証する
- [x] 階削除時に確認ダイアログが表示されることを検証する（データ存在時のみ）
- [x] 既存階の階名編集が引き続き動作することを検証する
- [x] 「階を追加」「削除」ボタンが削除されていることを検証する
- _Requirements: 1.1, 1.2, 5.1, 5.2, 5.3, 5.4, 6.3, 6.4, 7.1, 7.2, 10.1, 10.2, 10.3_

## 6. 既存データの移行とクリーンアップ

### 6.1 (P) 既存階データへのfloorType設定ヘルパーを実装
- [x] 既存の階データから階タイプを推測する関数（migrateFloorType）を実装する
- [x] 階名に"地下"が含まれる場合は'basement'、それ以外は'above-ground'を設定する
- [x] デフォルト値として'above-ground'を使用する
- [x] 既にfloorTypeが設定されている場合はスキップする
- _Requirements: 3.3, 5.1, 5.2, 5.3_

### 6.2 (P) 既存データ移行のテストを作成
- [x] 階名から階タイプが正しく推測されることを検証する
- [x] 既存のfloorTypeが保持されることを検証する
- [x] デフォルト値が正しく設定されることを検証する
- _Requirements: 3.3, 5.1, 5.2, 5.3_

## 7. エンドツーエンドテストとパフォーマンステスト

### 7.1 (P) 階数入力から階リスト更新までのE2Eテストを作成
- [x] ユーザーが地上階数5、地階数2を入力し、7階が表示されることを検証する
- [x] 地上階数を3に変更し、4階・5階が削除されることを検証する
- [x] 削除される階にデータがある場合、確認ダイアログが表示されることを検証する
- [x] キャンセルで変更が中止され、OKで階が削除されることを検証する
- [x] 階順序が論理的に表示されることを検証する
- _Requirements: 1.1, 1.2, 2.1, 2.2, 2.5, 2.6, 2.7, 5.1, 5.2, 5.3, 5.4, 8.2, 8.3, 8.4_

### 7.2 (P) アクセシビリティE2Eテストを作成
- [x] スクリーンリーダーで階数入力フィールドが正しく読み上げられることを検証する
- [x] キーボードのみで全操作が可能であることを検証する
- [x] フォーカス順序が論理的であることを検証する
- [x] バリデーションエラーがaria-live領域で通知されることを検証する
- _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

### 7.3 (P) 大規模建物でのパフォーマンステストを実施
- [x] 100階の建物で階数変更時の処理時間を測定する（< 1秒目標）
- [x] 階数入力時のレンダリングフレームレート（60fps維持）を測定する
- [x] カスケード削除の処理時間を測定する（大量のグループ共用部が存在する場合）
- [x] メモリ使用量を測定し、メモリリークがないことを確認する
- [x] パフォーマンス目標未達の場合、useMemo/useCallbackによる最適化を検討する
- _Requirements: 2.5, 2.6, 2.7, 4.4, 4.5, 4.6_

## 8. ドキュメント更新と最終検証

### 8.1 (P) 型定義とインターフェースのドキュメントを更新
- [x] Floor型のfloorTypeフィールドに関するJSDocコメントを追加する
- [x] 新規ユーティリティ関数のJSDocコメントを追加する
- [x] setFloorCounts関数のJSDocコメントを追加する
- _Requirements: 3.3_

### 8.2 (P) 全要件のカバレッジを検証
- [x] 全要件が実装タスクにマッピングされていることを確認する
- [x] 全テストが合格していることを確認する
- [x] パフォーマンス目標が達成されていることを確認する
- [x] アクセシビリティ要件が満たされていることを確認する
- _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.4, 8.5, 9.1, 9.2, 9.3, 9.4, 9.5, 10.1, 10.2, 10.3, 10.4_
