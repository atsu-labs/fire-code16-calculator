# 共用部按分の仕様書

## 概要
このドキュメントは、消防法用途別面積計算機における共用部按分の正確な仕様を定義します。

## 基本原則

### 按分の3つのタイプ

1. **階共用部**: その階の用途のみに按分
2. **建物共用部**: 全建物の用途コードに按分し、**その階にのみ加算**
3. **グループ共用部**: グループ内の用途コードに按分し、**その階にのみ加算**

### 重要な仕様ポイント

#### ❗ 建物共用部とグループ共用部の加算先
- **誤り**: 按分した面積を、その用途が存在する階に加算する
- **正解**: 按分した面積を、**共用部が存在する階にのみ加算する**

この仕様により、共用部の面積は物理的に存在する階に正しく集計されます。

## 詳細仕様

### 1. 階共用部

**対象**: その階に存在する用途のみ
**按分比率**: 用途の専有面積比
**加算先**: その階の各用途

#### 計算式
```
按分面積 = 階共用部 × (用途の専有面積 / その階の専有面積合計)
```

#### 例
```
入力:
  1階: 四項100㎡、五項ロ150㎡、階共用部50㎡

計算:
  四項への按分: 50 × (100 / 250) = 20㎡
  五項ロへの按分: 50 × (150 / 250) = 30㎡

結果:
  1階 四項: 100 + 20 = 120㎡
  1階 五項ロ: 150 + 30 = 180㎡
```

### 2. 建物共用部

**対象**: 全建物の全用途コード
**按分比率**: 用途コードの専有面積合計比（全建物）
**加算先**: ⚠️ **建物共用部が存在する階のみ**

#### 計算式
```
用途コードごとの専有面積合計 = Σ(全階のその用途コードの専有面積)
按分面積 = 建物共用部 × (用途コードの専有面積合計 / 全建物の専有面積合計)
```

#### 例1: 基本的なケース
```
入力:
  2階: 五項ロ200㎡、建物共用部100㎡
  1階: 四項100㎡、五項ロ150㎡

計算:
  全建物の専有面積: 100 + 200 + 150 = 450㎡
  四項の専有面積合計: 100㎡ (比率: 100/450)
  五項ロの専有面積合計: 350㎡ (比率: 350/450)
  
  2階の建物共用部100㎡を按分:
    四項への按分: 100 × (100/450) = 22.22㎡ → 2階に加算（仮想用途）
    五項ロへの按分: 100 × (350/450) = 77.78㎡ → 2階に加算

結果:
  2階 四項（仮想）: 0 + 22.22 = 22.22㎡
  2階 五項ロ: 200 + 77.78 = 277.78㎡
  1階 四項: 100 + 0 = 100㎡
  1階 五項ロ: 150 + 0 = 150㎡
```

#### 例2: 複数階に建物共用部がある場合
```
入力:
  2階: 五項ロ200㎡、建物共用部70㎡
  1階: 四項100㎡、建物共用部30㎡

計算:
  全建物の専有面積: 100 + 200 = 300㎡
  四項の専有面積合計: 100㎡ (比率: 100/300)
  五項ロの専有面積合計: 200㎡ (比率: 200/300)
  
  1階の建物共用部30㎡を按分:
    四項への按分: 30 × (100/300) = 10㎡ → 1階に加算
    五項ロへの按分: 30 × (200/300) = 20㎡ → 1階に加算（仮想用途）
  
  2階の建物共用部70㎡を按分:
    四項への按分: 70 × (100/300) = 23.33㎡ → 2階に加算（仮想用途）
    五項ロへの按分: 70 × (200/300) = 46.67㎡ → 2階に加算

結果:
  2階 四項（仮想）: 0 + 23.33 = 23.33㎡
  2階 五項ロ: 200 + 46.67 = 246.67㎡
  1階 四項: 100 + 10 = 110㎡
  1階 五項ロ（仮想）: 0 + 20 = 20㎡
```

### 3. グループ共用部

**対象**: グループに登録された用途コードのみ
**按分比率**: 用途コードの専有面積合計比（全建物）
**加算先**: ⚠️ **グループが存在する階のみ**

#### 計算式
```
用途コードごとの専有面積合計 = Σ(全階のその用途コードの専有面積)
按分面積 = グループ共用部 × (用途コードの専有面積合計 / グループ内の専有面積合計)
```

#### 例1: 基本的なケース
```
入力:
  2階: 二項ロ200㎡
  1階: 四項100㎡、五項ロ150㎡、グループ共用部100㎡
  グループ: 二項ロ、四項

計算:
  グループ内の専有面積合計: 200 + 100 = 300㎡
  二項ロの専有面積合計: 200㎡ (比率: 200/300)
  四項の専有面積合計: 100㎡ (比率: 100/300)
  
  1階のグループ共用部100㎡を按分:
    二項ロへの按分: 100 × (200/300) = 66.67㎡ → 1階に加算（仮想用途）
    四項への按分: 100 × (100/300) = 33.33㎡ → 1階に加算

結果:
  2階 二項ロ: 200 + 0 = 200㎡（グループ共用部は加算されない）
  1階 二項ロ（仮想）: 0 + 66.67 = 66.67㎡
  1階 四項: 100 + 33.33 = 133.33㎡
  1階 五項ロ: 150 + 0 = 150㎡（グループに含まれないため按分なし）
```

#### 例2: 複数階に同じ用途がある場合
```
入力:
  2階: 四項50㎡、五項ロ100㎡
  1階: 四項100㎡、五項ロ50㎡、グループ共用部60㎡
  グループ: 四項、五項ロ

計算:
  グループ内の専有面積合計: (50+100) + (100+50) = 300㎡
  四項の専有面積合計: 150㎡ (比率: 150/300)
  五項ロの専有面積合計: 150㎡ (比率: 150/300)
  
  1階のグループ共用部60㎡を按分:
    四項への按分: 60 × (150/300) = 30㎡ → 1階に加算
    五項ロへの按分: 60 × (150/300) = 30㎡ → 1階に加算

結果:
  2階 四項: 50 + 0 = 50㎡
  2階 五項ロ: 100 + 0 = 100㎡
  1階 四項: 100 + 30 = 130㎡
  1階 五項ロ: 50 + 30 = 80㎡
```

## 仮想用途

### 定義
共用部按分により、その階に実際には存在しない用途コードに按分が発生した場合、自動的に作成される用途エントリ。

### 特徴
- **専有面積**: 0㎡
- **共用部按分**: 按分された面積のみを持つ
- **表示**: 結果表示では実際の用途と同様に表示される
- **用途コード**: 実際の用途と同じ用途コード・用途名を使用

### 発生ケース

#### ケース1: 建物共用部による仮想用途
```
2階に建物共用部があり、1階にのみ存在する用途コードへの按分
→ 2階にその用途コードの仮想用途が作成される
```

#### ケース2: グループ共用部による仮想用途
```
1階にグループ共用部があり、2階にのみ存在する用途コードがグループに含まれる
→ 1階にその用途コードの仮想用途が作成される
```

## 実装上の注意点

### データ構造
```typescript
// 建物共用部の按分結果
buildingCommonByFloorAndCode: Map<FloorId, Map<AnnexedCode, DistributedArea>>

// グループ共用部の按分結果
usageGroupByFloorAndCode: Map<FloorId, Map<AnnexedCode, GroupData>>

// GroupData
{
  total: number,  // 按分面積合計
  details: DistributionDetail[]  // 按分詳細（複数グループ対応）
}
```

### 計算の流れ
1. 全建物の用途コード別専有面積合計を計算
2. 各階の建物共用部を用途コード別に按分（階ごとに記録）
3. 各階のグループ共用部を用途コード別に按分（階ごとに記録）
4. 各階ごとに：
   - 階共用部を按分
   - その階に存在すべき用途コード（実用途+仮想用途）を収集
   - 各用途コードの内訳を計算

### テストケース
詳細なテストケースは `src/contexts/CalculationActions.test.tsx` を参照してください。

## バージョン履歴

- v1.0.0 (2024-12-14): 初版作成
  - 建物共用部とグループ共用部の加算先を「共用部が存在する階」に修正
  - 仮想用途の自動作成機能を実装
